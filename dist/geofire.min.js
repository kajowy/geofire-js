/*!
 * GeoFire is an open-source library that allows you to store and query a set
 * of keys based on their geographic location. At its heart, GeoFire simply
 * stores locations with string keys. Its main benefit, however, is the
 * possibility of retrieving only those keys within a given geographic area -
 * all in realtime.
 *
 * GeoFire 0.0.0
 * https://github.com/firebase/geofire-js/
 * License: MIT
 */
var GeoFire=function(){"use strict";function e(e,n,t){return"undefined"==typeof t&&(t=null),g(e),m(n),{".priority":n,g:n,l:e,d:t}}function n(e){return null!==e&&e.hasOwnProperty("d")?e.d:null}function t(e){if(null!==e&&e.hasOwnProperty("l")&&Array.isArray(e.l)&&2===e.l.length)return e.l;throw new Error("Unexpected GeoFire location object encountered: "+JSON.stringify(e))}function r(e){var n;return n="function"==typeof e.key?e.key():"string"==typeof e.key||null===e.key?e.key:e.name()}var i=function(e){if(this.cancel=function(){"undefined"!=typeof n&&(n(),n=void 0)},"function"!=typeof e)throw new Error("callback must be a function");var n=e},a=function(r){if(this.ref=function(){return i},this.set=function(n,t,r){var a;if("string"==typeof n&&0!==n.length)a={},a[n]=t;else{if("object"!=typeof n)throw new Error("keyOrLocations must be a string or a mapping of key - location pairs.");if("undefined"!=typeof t)throw new Error("The location argument should not be used if you pass an object to set().");a=n}var o={};return Object.keys(a).forEach(function(n){v(n);var t=a[n];if(null===t)o[n]=null;else{g(t);var i=w(t);o[n]=e(t,i,r)}}),i.update(o)},this.get=function(e){return v(e),i.child(e).once("value").then(function(e){var n=e.val();return null===n?null:t(n)})},this.getWithData=function(e){return v(e),i.child(e).once("value").then(function(r){var i=r.val();return null===i?null:{key:e,location:t(i),data:n(i)}})},this.remove=function(e){return this.set(e,null)},this.query=function(e){return new I(i,e)},"[object Object]"!==Object.prototype.toString.call(r))throw new Error("firebaseRef must be an instance of Firebase");var i=r};a.distance=function(e,n){g(e),g(n);var t=6371,r=p(n[0]-e[0]),i=p(n[1]-e[1]),a=Math.sin(r/2)*Math.sin(r/2)+Math.cos(p(e[0]))*Math.cos(p(n[0]))*Math.sin(i/2)*Math.sin(i/2),o=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return t*o};var o=10,u="0123456789bcdefghjkmnpqrstuvwxyz",f=40007860,c=110574,l=5,s=22*l,d=6378137,h=.00669447819799,y=1e-12;Math.log2=Math.log2||function(e){return Math.log(e)/Math.log(2)};var v=function(e){var n;if("string"!=typeof e?n="key must be a string":0===e.length?n="key cannot be the empty string":1+o+e.length>755?n="key is too long to be stored in Firebase":/[\[\].#$\/\u0000-\u001F\u007F]/.test(e)&&(n="key cannot contain any of the following characters: . # $ ] [ /"),"undefined"!=typeof n)throw new Error("Invalid GeoFire key '"+e+"': "+n)},g=function(e){var n;if(Array.isArray(e))if(2!==e.length)n="expected array of length 2, got length "+e.length;else{var t=e[0],r=e[1];"number"!=typeof t||isNaN(t)?n="latitude must be a number":-90>t||t>90?n="latitude must be within the range [-90, 90]":"number"!=typeof r||isNaN(r)?n="longitude must be a number":(-180>r||r>180)&&(n="longitude must be within the range [-180, 180]")}else n="location must be an array";if("undefined"!=typeof n)throw new Error("Invalid GeoFire location '"+e+"': "+n)},m=function(e){var n;if("string"!=typeof e)n="geohash must be a string";else if(0===e.length)n="geohash cannot be the empty string";else for(var t=0,r=e.length;r>t;++t)-1===u.indexOf(e[t])&&(n='geohash cannot contain "'+e[t]+'"');if("undefined"!=typeof n)throw new Error("Invalid GeoFire geohash '"+e+"': "+n)},b=function(e,n){if("object"!=typeof e)throw new Error("query criteria must be an object");if("undefined"==typeof e.center&&"undefined"==typeof e.radius)throw new Error("radius and/or center must be specified");if(n&&("undefined"==typeof e.center||"undefined"==typeof e.radius))throw new Error("query criteria for a new query must contain both a center and a radius");for(var t=Object.keys(e),r=t.length,i=0;r>i;++i){var a=t[i];if("center"!==a&&"radius"!==a)throw new Error("Unexpected attribute '"+a+"'' found in query criteria")}if("undefined"!=typeof e.center&&g(e.center),"undefined"!=typeof e.radius){if("number"!=typeof e.radius||isNaN(e.radius))throw new Error("radius must be a number");if(e.radius<0)throw new Error("radius must be greater than or equal to 0")}},p=function(e){if("number"!=typeof e||isNaN(e))throw new Error("Error: degrees must be a number");return e*Math.PI/180},w=function(e,n){if(g(e),"undefined"!=typeof n){if("number"!=typeof n||isNaN(n))throw new Error("precision must be a number");if(0>=n)throw new Error("precision must be greater than 0");if(n>22)throw new Error("precision cannot be greater than 22");if(Math.round(n)!==n)throw new Error("precision must be an integer")}n=n||o;for(var t={min:-90,max:90},r={min:-180,max:180},i="",a=0,f=0,c=1;i.length<n;){var l=c?e[1]:e[0],s=c?r:t,d=(s.min+s.max)/2;l>d?(a=(a<<1)+1,s.min=d):(a=(a<<1)+0,s.max=d),c=!c,4>f?f++:(f=0,i+=u[a],a=0)}return i},k=function(e,n){var t=p(n),r=Math.cos(t)*d*Math.PI/180,i=1/Math.sqrt(1-h*Math.sin(t)*Math.sin(t)),a=r*i;return y>a?e>0?360:0:Math.min(360,e/a)},M=function(e,n){var t=k(e,n);return Math.abs(t)>1e-6?Math.max(1,Math.log2(360/t)):1},E=function(e){return Math.min(Math.log2(f/2/e),s)},O=function(e){if(180>=e&&e>=-180)return e;var n=e+180;return n>0?n%360-180:180- -n%360},x=function(e,n){var t=n/c,r=Math.min(90,e[0]+t),i=Math.max(-90,e[0]-t),a=2*Math.floor(E(n)),o=2*Math.floor(M(n,r))-1,u=2*Math.floor(M(n,i))-1;return Math.min(a,o,u,s)},_=function(e,n){var t=n/c,r=Math.min(90,e[0]+t),i=Math.max(-90,e[0]-t),a=k(n,r),o=k(n,i),u=Math.max(a,o);return[[e[0],e[1]],[e[0],O(e[1]-u)],[e[0],O(e[1]+u)],[r,e[1]],[r,O(e[1]-u)],[r,O(e[1]+u)],[i,e[1]],[i,O(e[1]-u)],[i,O(e[1]+u)]]},j=function(e,n){m(e);var t=Math.ceil(n/l);if(e.length<t)return[e,e+"~"];e=e.substring(0,t);var r=e.substring(0,e.length-1),i=u.indexOf(e.charAt(e.length-1)),a=n-r.length*l,o=l-a,f=i>>o<<o,c=f+(1<<o);return c>31?[r+u[f],r+"~"]:[r+u[f],r+u[c]]},C=function(e,n){g(e);var t=Math.max(1,x(e,n)),r=Math.ceil(t/l),i=_(e,n),a=i.map(function(e){return j(w(e,r),t)});return a.filter(function(e,n){return!a.some(function(t,r){return n>r&&e[0]===t[0]&&e[1]===t[1]})})},I=function(e,u){function f(e,n,t,r,i){j[e].forEach(function(e){"undefined"==typeof t||null===t?e(n,null,null,null):e(n,t,r,i)})}function c(){j.ready.forEach(function(e){e()})}function l(e){var n=e.split(":");if(2!==n.length)throw new Error("Invalid internal state! Not a valid geohash query: "+e);return n}function s(e){if(2!==e.length)throw new Error("Not a valid geohash query: "+e);return e[0]+":"+e[1]}function d(e,n){var t=_.orderByChild("g").startAt(e[0]).endAt(e[1]);t.off("child_added",n.childAddedCallback),t.off("child_removed",n.childRemovedCallback),t.off("child_changed",n.childChangedCallback),t.off("value",n.valueCallback)}function h(){for(var e=Object.keys(N),n=e.length,t=0;n>t;++t){var r=e[t],i=N[r];if(i.active===!1){var a=l(r);d(a,i),delete N[r]}}for(e=Object.keys(q),n=e.length,t=0;n>t;++t){var o=e[t];if(!v(q[o].geohash)){if(q[o].isInQuery)throw new Error("Internal State error, trying to remove location that is still in query");delete q[o]}}A=!1,null!==Q&&(clearTimeout(Q),Q=null)}function y(e,n,t){g(n);var r,i,u=q.hasOwnProperty(e)?q[e].isInQuery:!1,c=q.hasOwnProperty(e)?q[e].location:null;r=a.distance(n,G),i=R>=r,q[e]={location:n,data:t,distanceFromCenter:r,isInQuery:i,geohash:w(n,o)},i&&!u?f("key_entered",e,n,r,t):!i||null===c||n[0]===c[0]&&n[1]===c[1]?!i&&u&&f("key_exited",e,n,r):f("key_moved",e,n,r,t)}function v(e){for(var n=Object.keys(N),t=n.length,r=0;t>r;++r){var i=n[r];if(N.hasOwnProperty(i)){var a=l(i);if(e>=a[0]&&e<=a[1])return!0}}return!1}function m(e,n){var t=q[e];if(delete q[e],"undefined"!=typeof t&&t.isInQuery){var r=n?a.distance(n,G):null;f("key_exited",e,n,r)}}function p(e){var i=e.val();y(r(e),t(e.val()),n(i))}function k(e){var i=e.val();y(r(e),t(i),n(i))}function M(e){var n=r(e);q.hasOwnProperty(n)&&_.child(n).once("value",function(e){var r=null===e.val()?null:t(e.val()),i=null!==r?w(r):null;v(i)||m(n,r)})}function E(e){var n=x.indexOf(e);n>-1&&x.splice(n,1),F=0===x.length,F&&c()}function O(){var e=C(G,1e3*R).map(s);e=e.filter(function(n,t){return e.indexOf(n)===t});for(var n=Object.keys(N),t=n.length,r=0;t>r;++r){var i=n[r],a=e.indexOf(i);-1===a?N[i].active=!1:(N[i].active=!0,e.splice(a,1))}A===!1&&Object.keys(N).length>25&&(A=!0,Q=setTimeout(h,10)),x=e.slice(),e.forEach(function(e){var n=l(e),t=_.orderByChild("g").startAt(n[0]).endAt(n[1]),r=t.on("child_added",p),i=t.on("child_removed",M),a=t.on("child_changed",k),o=t.on("value",function(){t.off("value",o),E(e)});N[e]={active:!0,childAddedCallback:r,childRemovedCallback:i,childChangedCallback:a,valueCallback:o}}),0===e.length&&E()}if(this.center=function(){return G},this.radius=function(){return R},this.updateCriteria=function(e){b(e),G=e.center||G,R=e.radius||R;for(var n=Object.keys(q),t=n.length,r=0;t>r;++r){var i=n[r];if(I===!0)break;var o=q[i],u=o.isInQuery;o.distanceFromCenter=a.distance(o.location,G),o.isInQuery=o.distanceFromCenter<=R,u&&!o.isInQuery?f("key_exited",i,o.location,o.distanceFromCenter):!u&&o.isInQuery&&f("key_entered",i,o.location,o.distanceFromCenter,o.data)}F=!1,O()},this.on=function(e,n){if(-1===["ready","key_entered","key_exited","key_moved"].indexOf(e))throw new Error('event type must be "ready", "key_entered", "key_exited", or "key_moved"');if("function"!=typeof n)throw new Error("callback must be a function");if(j[e].push(n),"key_entered"===e)for(var t=Object.keys(q),r=t.length,a=0;r>a;++a){var o=t[a],u=q[o];"undefined"!=typeof u&&u.isInQuery&&n(o,u.location,u.distanceFromCenter,u.data)}return"ready"===e&&F&&n(),new i(function(){j[e].splice(j[e].indexOf(n),1)})},this.cancel=function(){I=!0,j={ready:[],key_entered:[],key_exited:[],key_moved:[]};for(var e=Object.keys(N),n=e.length,t=0;n>t;++t){var r=e[t],i=l(r);d(i,N[r]),delete N[r]}q={},clearInterval(P)},"[object Object]"!==Object.prototype.toString.call(e))throw new Error("firebaseRef must be an instance of Firebase");var x,_=e,j={ready:[],key_entered:[],key_exited:[],key_moved:[]},I=!1,F=!1,q={},N={},A=!1,Q=null,P=setInterval(function(){A===!1&&h()},1e4);b(u,!0);var G=u.center,R=u.radius;O()};return a}();"undefined"!=typeof module&&"undefined"!=typeof process&&(module.exports=GeoFire);